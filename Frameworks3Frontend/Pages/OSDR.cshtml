@page
@{
    ViewData["Title"] = "OSDR";
}

<div class="card">
    <h2>NASA OSDR</h2>

    <div class="form-row">
        <input type="text" id="search" placeholder="Поиск" class="form-control">
        <select id="sort" class="form-control">
            <option value="id">По ID</option>
            <option value="title">По названию</option>
            <option value="date">По дате</option>
        </select>
        <button id="refresh" class="btn">Обновить</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Дата</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="osdrTable">
                <!-- жс подгрузка -->
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <button id="prevBtn" class="btn">Назад</button>
        <span id="pageInfo">Страница 1</span>
        <button id="nextBtn" class="btn">Вперед</button>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let itemsPerPage = 20;
        let allData = [];

        async function loadOsdrData() {
            try {
                const response = await fetch('/Osdr/all');
                if (!response.ok) throw new Error('Ошибка загрузки');

                allData = await response.json();
                renderTable();
            } catch (error) {
                document.getElementById('osdrTable').innerHTML =
                    '<tr><td colspan="4">Ошибка загрузки</td></tr>';
            }
        }

        function filterData() {
            const search = document.getElementById('search').value.toLowerCase();
            const sortBy = document.getElementById('sort').value;

            let filtered = [...allData];

            if (search) {
                filtered = filtered.filter(item =>
                    (item.title && item.title.toLowerCase().includes(search)) ||
                    (item.datasetId && item.datasetId.toLowerCase().includes(search))
                );
            }

            if (sortBy === 'title') {
                filtered.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            } else if (sortBy === 'date') {
                filtered.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            }

            return filtered;
        }

        function renderTable() {
            const filteredData = filterData();
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            document.getElementById('pageInfo').textContent =
                `Страница ${currentPage} из ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;

            const tbody = document.getElementById('osdrTable');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Нет данных</td></tr>';
                return;
            }

            pageData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.title || '—'}</td>
                    <td>${new Date(item.updatedAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn" onclick="showDetails(${item.id})">Подробнее</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showDetails(id) {
            const item = allData.find(i => i.id === id);
            if (item) {
                let details = '';
                try {
                    const raw = JSON.parse(item.raw);
                    details = JSON.stringify(raw, null, 2);
                } catch {
                    details = item.raw || 'Нет данных';
                }
                alert(details);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadOsdrData();

            document.getElementById('search').addEventListener('input', () => {
                currentPage = 1;
                renderTable();
            });

            document.getElementById('sort').addEventListener('change', renderTable);
            document.getElementById('refresh').addEventListener('click', loadOsdrData);
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            document.getElementById('nextBtn').addEventListener('click', () => {
                const filtered = filterData();
                const totalPages = Math.ceil(filtered.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
        });
    </script>
}